import{d as L,r as _,q as Q,g as j,m as J,h as K,M as r,f as W,c as X,a,w as l,b as i,e as u,n as g,t as v,u as O,v as Z,o as ee,_ as te}from"./index-DyLEHBAm.js";import{a as P}from"./constants-Dn4t5xCD.js";import{g as ae,a as se,d as le,b as oe,e as ne}from"./api-BgQpdBzD.js";import{g as re}from"./localStorage-DajKA7mC.js";const ie={class:"performance-sessions"},ue={class:"performance-info-content"},me={class:"performance-cover"},de=["src"],ce={class:"performance-details"},fe=L({__name:"PerformanceSessions",setup(pe){const S=J(),V=W(),p=_(null),U=Q(()=>p.value?[{label:"演出标题",value:p.value.title},{label:"演出场馆",value:p.value.venue},{label:"演出状态",value:P[p.value.status]}]:[]),k=_(!1),c=_([]),T=_(!1),x=_(),f=_(null),o=j({title:"",performanceId:Number(S.params.id),saleTimeRange:[],showTimeRange:[],status:"COMING_SOON"}),q={saleTimeRange:[{required:!0,message:"请选择售卖时间范围"}],showTimeRange:[{required:!0,message:"请选择演出时间范围"}],status:[{required:!0,message:"请选择状态"}]};K(async()=>{const t=Number(S.params.id);if(t)try{k.value=!0;const e=await ae(t);if(e){p.value=e;const m=await se(t);c.value=m}else r.error("演出不存在"),V.push("/performances")}catch(e){console.error("加载数据失败:",e),r.error("加载数据失败")}finally{k.value=!1}});const z=()=>{f.value=null,o.title="",o.saleTimeRange=[],o.showTimeRange=[],o.status="COMING_SOON",T.value=!0},A=t=>{f.value=t,o.title=t.title||"",o.saleTimeRange=[t.startSaleTime,t.endSaleTime],o.showTimeRange=[t.startShowTime,t.endShowTime],o.status=t.status,T.value=!0},E=async t=>{if(x.value)try{const e=await x.value.validate();if(e)return console.error("表单验证失败:",e),t(!1);const[m,N]=o.saleTimeRange,[w,D]=o.showTimeRange;if(N<=m)return r.error("售卖结束时间必须晚于售卖开始时间"),t(!1);if(D<=w)return r.error("演出结束时间必须晚于演出开始时间"),t(!1);if(w<=m)return r.error("演出开始时间必须晚于售卖开始时间"),t(!1);const d=Number(S.params.id),h={performanceId:d,title:o.title,startSaleTime:o.saleTimeRange[0],endSaleTime:o.saleTimeRange[1],startShowTime:o.showTimeRange[0],endShowTime:o.showTimeRange[1],status:o.status};if(f.value&&f.value.id)try{const n=await oe(d,f.value.id,h);if(n){const y=c.value.findIndex(I=>{var R;return I.id===((R=f.value)==null?void 0:R.id)});return y!==-1&&(c.value[y]=n),r.success("更新成功"),t(!0)}}catch(n){return console.error("更新场次失败:",n),r.error("更新失败"),t(!1)}else try{const n=await ne(d,h);return c.value.push(n),r.success("创建成功"),t(!0)}catch(n){return console.error("创建场次失败:",n),r.error("创建失败"),t(!1)}return r.error("操作失败"),t(!1)}catch(e){return console.error("表单验证失败:",e),r.error("请填写必填项"),t(!1)}},F=t=>{Z.warning({title:"确认删除",content:"确定要删除该场次吗？",onOk:async()=>{const e=Number(S.params.id);try{if(!t.id){r.error("场次ID无效");return}await le(e,t.id),c.value=c.value.filter(m=>m.id!==t.id),r.success("删除成功")}catch(m){console.error("删除场次失败:",m),r.error("删除失败")}}})},$=()=>{T.value=!1},b=t=>new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(t));return(t,e)=>{const m=i("a-typography-title"),N=i("a-descriptions"),w=i("a-card"),D=i("icon-plus"),d=i("a-button"),h=i("a-space"),n=i("a-table-column"),y=i("a-tag"),I=i("a-table"),R=i("a-input"),M=i("a-form-item"),Y=i("a-range-picker"),H=i("a-form"),B=i("a-modal");return ee(),X("div",ie,[a(m,{heading:3,style:{"margin-top":"0px","margin-bottom":"24px"}},{default:l(()=>e[4]||(e[4]=[u("场次管理")])),_:1}),a(w,{class:"performance-info",style:{"margin-bottom":"16px"}},{title:l(()=>e[5]||(e[5]=[u("基本信息")])),default:l(()=>{var s;return[g("div",ue,[g("div",me,[g("img",{src:(s=p.value)==null?void 0:s.coverUrl,alt:"演出封面"},null,8,de)]),g("div",ce,[a(N,{data:U.value,layout:"inline-horizontal",column:1},null,8,["data"])])])]}),_:1}),a(w,null,{title:l(()=>[a(h,null,{default:l(()=>[a(d,{type:"primary",onClick:z},{icon:l(()=>[a(D)]),default:l(()=>[e[6]||(e[6]=u(" 添加场次 "))]),_:1})]),_:1})]),default:l(()=>[a(I,{data:c.value,loading:k.value,pagination:!1,bordered:!1},{columns:l(()=>[a(n,{title:"场次ID","data-index":"id",width:100}),a(n,{title:"场次标题","data-index":"title",width:150}),a(n,{title:"售卖时间",width:300},{cell:l(({record:s})=>[u(v(b(s.startSaleTime))+" - ",1),e[7]||(e[7]=g("br",null,null,-1)),u(" "+v(b(s.endSaleTime)),1)]),_:1}),a(n,{title:"演出时间",width:250},{cell:l(({record:s})=>[u(v(b(s.startShowTime))+" - ",1),e[8]||(e[8]=g("br",null,null,-1)),u(" "+v(b(s.endShowTime)),1)]),_:1}),a(n,{title:"总票数",width:120},{cell:l(({record:s})=>[u(v(O(re)(s.performanceId,s.id).reduce((C,G)=>C+G.totalQuantity,0)),1)]),_:1}),a(n,{title:"状态","data-index":"status",width:100},{cell:l(({record:s})=>[a(y,{color:{ON_SALE:"green",COMING_SOON:"blue",SOLD_OUT:"red"}[s.status]},{default:l(()=>[u(v(O(P)[s.status]),1)]),_:2},1032,["color"])]),_:1}),a(n,{title:"操作",align:"center",width:150},{cell:l(({record:s})=>[a(h,null,{default:l(()=>[a(d,{type:"text",size:"small",onClick:C=>A(s)},{default:l(()=>e[9]||(e[9]=[u(" 编辑 ")])),_:2},1032,["onClick"]),a(d,{type:"text",size:"small",onClick:C=>O(V).push(`/performances/${s.performanceId}/sessions/${s.id}/tickets`)},{default:l(()=>e[10]||(e[10]=[u(" 票档管理 ")])),_:2},1032,["onClick"]),a(d,{type:"text",status:"danger",size:"small",onClick:C=>F(s)},{default:l(()=>e[11]||(e[11]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data","loading"])]),_:1}),a(B,{visible:T.value,"onUpdate:visible":e[3]||(e[3]=s=>T.value=s),title:f.value?"编辑场次":"新增场次","on-before-ok":E,onCancel:$},{default:l(()=>[a(H,{ref_key:"sessionFormRef",ref:x,model:o,rules:q,"auto-label-width":""},{default:l(()=>[a(M,{field:"title",label:"场次标题"},{default:l(()=>[a(R,{modelValue:o.title,"onUpdate:modelValue":e[0]||(e[0]=s=>o.title=s),placeholder:"请输入场次标题（可选）","allow-clear":""},null,8,["modelValue"])]),_:1}),a(M,{field:"saleTimeRange",label:"售卖时间",rules:[{required:!0,message:"请选择售卖时间范围"}]},{default:l(()=>[a(Y,{modelValue:o.saleTimeRange,"onUpdate:modelValue":e[1]||(e[1]=s=>o.saleTimeRange=s),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(M,{field:"showTimeRange",label:"演出时间",rules:[{required:!0,message:"请选择演出时间范围"}]},{default:l(()=>[a(Y,{modelValue:o.showTimeRange,"onUpdate:modelValue":e[2]||(e[2]=s=>o.showTimeRange=s),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),we=te(fe,[["__scopeId","data-v-0549274b"]]);export{we as default};
