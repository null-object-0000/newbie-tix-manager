import{d as B,r as _,q as G,g as j,m as J,h as K,M as r,f as Q,c as W,a,w as l,b as i,e as u,n as g,t as S,u as E,v as X,o as Z,_ as ee}from"./index-IoAneAfo.js";import{a as Y}from"./constants-CeZz7UqS.js";import{g as te,d as ae,e as se,h as le,i as oe}from"./api-rjBpfQPZ.js";const ne={class:"performance-sessions"},re={class:"performance-info-content"},ie={class:"performance-cover"},ue=["src"],me={class:"performance-details"},de=B({__name:"PerformanceSessions",setup(ce){const h=J(),I=Q(),p=_(null),A=G(()=>p.value?[{label:"演出标题",value:p.value.title},{label:"演出场馆",value:p.value.venue},{label:"演出状态",value:Y[p.value.status]}]:[]),x=_(!1),c=_([]),v=_(!1),k=_(),f=_(null),o=j({title:"",performanceId:Number(h.params.id),saleTimeRange:[],showTimeRange:[],status:"ON_SALE"}),F={saleTimeRange:[{required:!0,message:"请选择售卖时间范围"}],showTimeRange:[{required:!0,message:"请选择演出时间范围"}],status:[{required:!0,message:"请选择状态"}]};K(async()=>{const t=Number(h.params.id);if(t)try{x.value=!0;const e=await te(t);if(e){p.value=e;const m=await ae(t);c.value=m}else r.error("演出不存在"),I.push("/performances")}catch(e){console.error("加载数据失败:",e),r.error("加载数据失败")}finally{x.value=!1}});const U=()=>{f.value=null,o.title="",o.saleTimeRange=[],o.showTimeRange=[],o.status="ON_SALE",v.value=!0},q=t=>{f.value=t,o.title=t.title||"",o.saleTimeRange=[t.startSaleTime,t.endSaleTime],o.showTimeRange=[t.startShowTime,t.endShowTime],o.status=t.status,v.value=!0},P=async t=>{if(k.value)try{const e=await k.value.validate();if(e)return console.error("表单验证失败:",e),t(!1);const[m,C]=o.saleTimeRange,[w,N]=o.showTimeRange;if(C<=m)return r.error("售卖结束时间必须晚于售卖开始时间"),t(!1);if(N<=w)return r.error("演出结束时间必须晚于演出开始时间"),t(!1);if(w<=m)return r.error("演出开始时间必须晚于售卖开始时间"),t(!1);const d=Number(h.params.id),T={performanceId:d,title:o.title,startSaleTime:o.saleTimeRange[0],endSaleTime:o.saleTimeRange[1],startShowTime:o.showTimeRange[0],endShowTime:o.showTimeRange[1],status:o.status};if(f.value&&f.value.id)try{const n=await le(d,f.value.id,T);if(n){const y=c.value.findIndex(D=>{var R;return D.id===((R=f.value)==null?void 0:R.id)});return y!==-1&&(c.value[y]=n),r.success("更新成功"),t(!0)}}catch(n){return console.error("更新场次失败:",n),r.error("更新失败"),t(!1)}else try{const n=await oe(d,T);return c.value.push(n),r.success("创建成功"),t(!0)}catch(n){return console.error("创建场次失败:",n),r.error("创建失败"),t(!1)}return r.error("操作失败"),t(!1)}catch(e){return console.error("表单验证失败:",e),r.error("请填写必填项"),t(!1)}},z=t=>{X.warning({title:"确认删除",content:"确定要删除该场次吗？",onOk:async()=>{const e=Number(h.params.id);try{if(!t.id){r.error("场次ID无效");return}await se(e,t.id),c.value=c.value.filter(m=>m.id!==t.id),r.success("删除成功")}catch(m){console.error("删除场次失败:",m),r.error("删除失败")}}})},L=()=>{v.value=!1},b=t=>new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(t));return(t,e)=>{const m=i("a-typography-title"),C=i("a-descriptions"),w=i("a-card"),N=i("icon-plus"),d=i("a-button"),T=i("a-space"),n=i("a-table-column"),y=i("a-tag"),D=i("a-table"),R=i("a-input"),V=i("a-form-item"),M=i("a-range-picker"),$=i("a-form"),H=i("a-modal");return Z(),W("div",ne,[a(m,{heading:3,style:{"margin-top":"0px","margin-bottom":"24px"}},{default:l(()=>e[4]||(e[4]=[u("场次管理")])),_:1}),a(w,{class:"performance-info",style:{"margin-bottom":"16px"}},{title:l(()=>e[5]||(e[5]=[u("基本信息")])),default:l(()=>{var s;return[g("div",re,[g("div",ie,[g("img",{src:(s=p.value)==null?void 0:s.coverUrl,alt:"演出封面"},null,8,ue)]),g("div",me,[a(C,{data:A.value,layout:"inline-horizontal",column:1},null,8,["data"])])])]}),_:1}),a(w,null,{title:l(()=>[a(T,null,{default:l(()=>[a(d,{type:"primary",onClick:U},{icon:l(()=>[a(N)]),default:l(()=>[e[6]||(e[6]=u(" 添加场次 "))]),_:1})]),_:1})]),default:l(()=>[a(D,{data:c.value,loading:x.value,pagination:!1,bordered:!1},{columns:l(()=>[a(n,{title:"场次ID","data-index":"id",width:100}),a(n,{title:"场次标题","data-index":"title",width:150}),a(n,{title:"售卖时间",width:300},{cell:l(({record:s})=>[u(S(b(s.startSaleTime))+" - ",1),e[7]||(e[7]=g("br",null,null,-1)),u(" "+S(b(s.endSaleTime)),1)]),_:1}),a(n,{title:"演出时间",width:250},{cell:l(({record:s})=>[u(S(b(s.startShowTime))+" - ",1),e[8]||(e[8]=g("br",null,null,-1)),u(" "+S(b(s.endShowTime)),1)]),_:1}),a(n,{title:"总票数",width:120},{cell:l(({record:s})=>e[9]||(e[9]=[u(" 0 ")])),_:1}),a(n,{title:"状态","data-index":"status",width:100},{cell:l(({record:s})=>[a(y,{color:{ON_SALE:"green",COMING_SOON:"blue",SOLD_OUT:"red",OFFLINE:"orange"}[s.status]},{default:l(()=>[u(S(E(Y)[s.status]),1)]),_:2},1032,["color"])]),_:1}),a(n,{title:"操作",align:"center",width:150},{cell:l(({record:s})=>[a(T,null,{default:l(()=>[a(d,{type:"text",size:"small",onClick:O=>q(s)},{default:l(()=>e[10]||(e[10]=[u(" 编辑 ")])),_:2},1032,["onClick"]),a(d,{type:"text",size:"small",onClick:O=>E(I).push(`/performances/${s.performanceId}/sessions/${s.id}/tickets`)},{default:l(()=>e[11]||(e[11]=[u(" 票档管理 ")])),_:2},1032,["onClick"]),a(d,{type:"text",status:"danger",size:"small",onClick:O=>z(s)},{default:l(()=>e[12]||(e[12]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data","loading"])]),_:1}),a(H,{visible:v.value,"onUpdate:visible":e[3]||(e[3]=s=>v.value=s),title:f.value?"编辑场次":"新增场次","on-before-ok":P,onCancel:L},{default:l(()=>[a($,{ref_key:"sessionFormRef",ref:k,model:o,rules:F,"auto-label-width":""},{default:l(()=>[a(V,{field:"title",label:"场次标题"},{default:l(()=>[a(R,{modelValue:o.title,"onUpdate:modelValue":e[0]||(e[0]=s=>o.title=s),placeholder:"请输入场次标题（可选）","allow-clear":""},null,8,["modelValue"])]),_:1}),a(V,{field:"saleTimeRange",label:"售卖时间",rules:[{required:!0,message:"请选择售卖时间范围"}]},{default:l(()=>[a(M,{modelValue:o.saleTimeRange,"onUpdate:modelValue":e[1]||(e[1]=s=>o.saleTimeRange=s),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(V,{field:"showTimeRange",label:"演出时间",rules:[{required:!0,message:"请选择演出时间范围"}]},{default:l(()=>[a(M,{modelValue:o.showTimeRange,"onUpdate:modelValue":e[2]||(e[2]=s=>o.showTimeRange=s),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),ge=ee(de,[["__scopeId","data-v-af002c0d"]]);export{ge as default};
