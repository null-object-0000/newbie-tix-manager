import{d as G,r as f,q as S,g as H,x as J,m as K,M as _,f as L,c as W,a,w as l,b as s,e as g,n as k,t as X,v as Y,o as Z,_ as ee}from"./index-BgaZ_YDm.js";import{g as te,i as ae,j as le,k as oe,l as ne,m as se}from"./api-Dv_fDl34.js";import{a as ie}from"./constants-Dn4t5xCD.js";const re={class:"performance-tickets"},ue={class:"info-content"},ce={class:"performance-info"},de={class:"performance-cover"},me=["src"],pe={class:"performance-details"},fe={class:"session-info"},_e=G({__name:"PerformanceTickets",setup(ve){const u=K(),D=L(),d=f(null),m=f(null),q=S(()=>d.value?[{label:"演出标题",value:d.value.title},{label:"演出场馆",value:d.value.venue},{label:"演出状态",value:ie[d.value.status]}]:[]),M=S(()=>!d.value||!m.value?[]:[{label:"场次标题",value:m.value.title||"无"},{label:"售卖时间",value:`${T(m.value.startSaleTime)} - ${T(m.value.endSaleTime)}`},{label:"演出时间",value:`${T(m.value.startShowTime)} - ${T(m.value.endShowTime)}`}]),h=f(!1),p=f([]),w=f(!1),x=f(),v=f(null),o=H({title:"",price:0,totalQuantity:0}),R={title:[{required:!0,message:"请输入票档标题"}],price:[{required:!0,message:"请输入票档价格"}],totalQuantity:[{required:!0,message:"请输入总票数"}]};J(async()=>{const t=Number(u.params.performanceId),e=Number(u.params.sessionId);if(t&&e){const r=await te(t),i=await ae(t,e);r&&i?(d.value=r,m.value=i,await C()):(_.error("场次不存在"),D.push(`/performances/${t}/sessions`))}});const C=async()=>{const t=Number(u.params.performanceId),e=Number(u.params.sessionId);t&&e&&(h.value=!0,p.value=await le(t,e),h.value=!1)},$=()=>{v.value=null,o.title="",o.price=0,o.totalQuantity=0,w.value=!0},P=t=>{v.value=t,o.title=t.title,o.price=t.price,o.totalQuantity=t.totalQuantity,w.value=!0},U=async t=>{if(x.value)try{const e=await x.value.validate();if(e)return console.error("表单验证失败:",e),t(!1);const r=Number(u.params.performanceId),i=Number(u.params.sessionId),I={performanceId:r,sessionId:i,title:o.title,price:o.price,totalQuantity:o.totalQuantity};if(v.value){const b=await ne(r,i,v.value.id,I);if(b){const y=p.value.findIndex(N=>{var c;return N.id===((c=v.value)==null?void 0:c.id)});return y!==-1&&(p.value[y]=b),_.success("更新成功"),C(),t(!0)}}else{const b=await se(r,i,I);return p.value.push(b),_.success("创建成功"),C(),t(!0)}return _.error("操作失败"),t(!1)}catch(e){return console.error("表单验证失败:",e),_.error("请填写必填项"),t(!1)}},z=async t=>{Y.warning({title:"确认删除",content:"确定要删除该票档吗？",hideCancel:!1,onOk:async()=>{const e=Number(u.params.performanceId),r=Number(u.params.sessionId);await oe(e,r,t.id)?(p.value=p.value.filter(i=>i.id!==t.id),_.success("删除成功")):_.error("删除失败")}})},F=()=>{w.value=!1},T=t=>new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(t));return(t,e)=>{const r=s("a-typography-title"),i=s("a-descriptions"),I=s("a-card"),b=s("icon-plus"),y=s("a-button"),N=s("a-space"),c=s("a-table-column"),A=s("a-table"),B=s("a-input"),V=s("a-form-item"),Q=s("a-input-number"),E=s("a-form"),O=s("a-modal");return Z(),W("div",re,[a(r,{heading:3,style:{"margin-top":"0px","margin-bottom":"24px"}},{default:l(()=>e[4]||(e[4]=[g("票档管理")])),_:1}),a(I,{class:"info-card",style:{"margin-bottom":"16px"}},{title:l(()=>e[5]||(e[5]=[g("基本信息")])),default:l(()=>{var n;return[k("div",ue,[k("div",ce,[k("div",de,[k("img",{src:(n=d.value)==null?void 0:n.coverUrl,alt:"演出封面"},null,8,me)]),k("div",pe,[a(i,{data:q.value,layout:"inline-horizontal",column:1},null,8,["data"])])]),k("div",fe,[a(i,{data:M.value,layout:"inline-horizontal",column:1},null,8,["data"])])])]}),_:1}),a(I,null,{title:l(()=>[a(N,null,{default:l(()=>[a(y,{type:"primary",onClick:$},{icon:l(()=>[a(b)]),default:l(()=>[e[6]||(e[6]=g(" 添加票档 "))]),_:1})]),_:1})]),default:l(()=>[a(A,{data:p.value,loading:h.value,pagination:!1,bordered:!1},{columns:l(()=>[a(c,{title:"票档ID","data-index":"id",width:85}),a(c,{title:"票档标题","data-index":"title",width:150}),a(c,{title:"票档价格",width:120},{cell:l(({record:n})=>[g(" ¥"+X(n.price),1)]),_:1}),a(c,{title:"总票数","data-index":"totalQuantity",width:150}),a(c,{title:"操作",width:150},{cell:l(({record:n})=>[a(y,{type:"text",size:"small",onClick:j=>P(n)},{default:l(()=>e[7]||(e[7]=[g(" 编辑 ")])),_:2},1032,["onClick"]),a(y,{type:"text",status:"danger",size:"small",onClick:j=>z(n)},{default:l(()=>e[8]||(e[8]=[g(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","loading"])]),_:1}),a(O,{visible:w.value,"onUpdate:visible":e[3]||(e[3]=n=>w.value=n),title:v.value?"编辑票档":"新增票档","on-before-ok":U,onCancel:F},{default:l(()=>[a(E,{ref_key:"ticketFormRef",ref:x,model:o,rules:R,"auto-label-width":""},{default:l(()=>[a(V,{field:"title",label:"票档标题",rules:[{required:!0,message:"请输入票档标题"}]},{default:l(()=>[a(B,{modelValue:o.title,"onUpdate:modelValue":e[0]||(e[0]=n=>o.title=n),placeholder:"请输入票档标题","allow-clear":""},null,8,["modelValue"])]),_:1}),a(V,{field:"price",label:"票档价格",rules:[{required:!0,message:"请输入票档价格"}]},{default:l(()=>[a(Q,{modelValue:o.price,"onUpdate:modelValue":e[1]||(e[1]=n=>o.price=n),min:0,precision:2,placeholder:"请输入票档价格"},null,8,["modelValue"])]),_:1}),a(V,{field:"totalQuantity",label:"总票数",rules:[{required:!0,message:"请输入总票数"}]},{default:l(()=>[a(Q,{modelValue:o.totalQuantity,"onUpdate:modelValue":e[2]||(e[2]=n=>o.totalQuantity=n),min:1,precision:0,placeholder:"请输入总票数"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),ke=ee(_e,[["__scopeId","data-v-5a3e78c5"]]);export{ke as default};
