import{d as j,r as _,q as G,g as J,m as K,h as L,M as u,f as W,c as X,a as t,w as l,b as n,e as r,n as g,t as v,u as N,v as Z,o as ee,_ as te}from"./index-BS8JmWLW.js";import{a as q}from"./constants-YvDzxIri.js";import{b as ae,g as se,a as le,d as oe,e as ne,h as ie}from"./localStorage-5GgEftBe.js";const re={class:"performance-sessions"},ue={class:"performance-info-content"},me={class:"performance-cover"},de=["src"],ce={class:"performance-details"},fe=j({__name:"PerformanceSessions",setup(pe){const b=K(),Y=W(),c=_(null),U=G(()=>c.value?[{label:"演出标题",value:c.value.title},{label:"演出场馆",value:c.value.venue},{label:"演出状态",value:q[c.value.status]}]:[]),x=_(!1),d=_([]),T=_(!1),C=_(),f=_(null),o=J({title:"",performanceId:Number(b.params.id),saleTimeRange:[],showTimeRange:[],status:"coming_soon"}),z={saleTimeRange:[{required:!0,message:"请选择售卖时间范围"}],showTimeRange:[{required:!0,message:"请选择演出时间范围"}],status:[{required:!0,message:"请选择状态"}]};L(()=>{const s=Number(b.params.id);if(s){const e=ae(s);e?(c.value=e,x.value=!0,d.value=se(s),x.value=!1):(u.error("演出不存在"),Y.push("/performances"))}});const F=()=>{f.value=null,o.title="",o.saleTimeRange=[],o.showTimeRange=[],o.status="coming_soon",T.value=!0},$=s=>{f.value=s,o.title=s.title||"",o.saleTimeRange=[s.startSaleTime,s.endSaleTime],o.showTimeRange=[s.startShowTime,s.endShowTime],o.status=s.status,T.value=!0},A=async s=>{if(C.value)try{const e=await C.value.validate();if(e)return console.error("表单验证失败:",e),s(!1);const[p,V]=o.saleTimeRange,[w,D]=o.showTimeRange;if(V<=p)return u.error("售卖结束时间必须晚于售卖开始时间"),s(!1);if(D<=w)return u.error("演出结束时间必须晚于演出开始时间"),s(!1);if(w<=p)return u.error("演出开始时间必须晚于售卖开始时间"),s(!1);const m=Number(b.params.id),h={performanceId:m,title:o.title,startSaleTime:o.saleTimeRange[0],endSaleTime:o.saleTimeRange[1],startShowTime:o.showTimeRange[0],endShowTime:o.showTimeRange[1],status:o.status};if(f.value){const i=ne(m,f.value.id,h);if(i){const R=d.value.findIndex(M=>{var y;return M.id===((y=f.value)==null?void 0:y.id)});return R!==-1&&(d.value[R]=i),u.success("更新成功"),s(!0)}}else{const i=ie(m,h);return d.value.push(i),u.success("创建成功"),s(!0)}return u.error("操作失败"),s(!1)}catch(e){return console.error("表单验证失败:",e),u.error("请填写必填项"),s(!1)}},E=s=>{Z.warning({title:"确认删除",content:"确定要删除该场次吗？",onOk:()=>{const e=Number(b.params.id);oe(e,s.id)?(d.value=d.value.filter(p=>p.id!==s.id),u.success("删除成功")):u.error("删除失败")}})},H=()=>{T.value=!1},S=s=>new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(s));return(s,e)=>{const p=n("a-typography-title"),V=n("a-descriptions"),w=n("a-card"),D=n("icon-plus"),m=n("a-button"),h=n("a-space"),i=n("a-table-column"),R=n("a-tag"),M=n("a-table"),y=n("a-input"),I=n("a-form-item"),P=n("a-range-picker"),B=n("a-form"),O=n("a-modal");return ee(),X("div",re,[t(p,{heading:3,style:{"margin-top":"0px","margin-bottom":"24px"}},{default:l(()=>e[4]||(e[4]=[r("场次管理")])),_:1}),t(w,{class:"performance-info",style:{"margin-bottom":"16px"}},{title:l(()=>e[5]||(e[5]=[r("基本信息")])),default:l(()=>{var a;return[g("div",ue,[g("div",me,[g("img",{src:(a=c.value)==null?void 0:a.coverUrl,alt:"演出封面"},null,8,de)]),g("div",ce,[t(V,{data:U.value,layout:"inline-horizontal",column:1},null,8,["data"])])])]}),_:1}),t(w,null,{title:l(()=>[t(h,null,{default:l(()=>[t(m,{type:"primary",onClick:F},{icon:l(()=>[t(D)]),default:l(()=>[e[6]||(e[6]=r(" 添加场次 "))]),_:1})]),_:1})]),default:l(()=>[t(M,{data:d.value,loading:x.value,pagination:!1,bordered:!1},{columns:l(()=>[t(i,{title:"场次ID","data-index":"id",width:100}),t(i,{title:"场次标题","data-index":"title",width:150}),t(i,{title:"售卖时间",width:300},{cell:l(({record:a})=>[r(v(S(a.startSaleTime))+" - ",1),e[7]||(e[7]=g("br",null,null,-1)),r(" "+v(S(a.endSaleTime)),1)]),_:1}),t(i,{title:"演出时间",width:250},{cell:l(({record:a})=>[r(v(S(a.startShowTime))+" - ",1),e[8]||(e[8]=g("br",null,null,-1)),r(" "+v(S(a.endShowTime)),1)]),_:1}),t(i,{title:"总票数",width:120},{cell:l(({record:a})=>[r(v(N(le)(a.performanceId,a.id).reduce((k,Q)=>k+Q.totalQuantity,0)),1)]),_:1}),t(i,{title:"状态","data-index":"status",width:100},{cell:l(({record:a})=>[t(R,{color:{on_sale:"green",coming_soon:"blue",sold_out:"red"}[a.status]},{default:l(()=>[r(v(N(q)[a.status]),1)]),_:2},1032,["color"])]),_:1}),t(i,{title:"操作",align:"center",width:150},{cell:l(({record:a})=>[t(h,null,{default:l(()=>[t(m,{type:"text",size:"small",onClick:k=>$(a)},{default:l(()=>e[9]||(e[9]=[r(" 编辑 ")])),_:2},1032,["onClick"]),t(m,{type:"text",size:"small",onClick:k=>N(Y).push(`/performances/${a.performanceId}/sessions/${a.id}/tickets`)},{default:l(()=>e[10]||(e[10]=[r(" 票档管理 ")])),_:2},1032,["onClick"]),t(m,{type:"text",status:"danger",size:"small",onClick:k=>E(a)},{default:l(()=>e[11]||(e[11]=[r(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data","loading"])]),_:1}),t(O,{visible:T.value,"onUpdate:visible":e[3]||(e[3]=a=>T.value=a),title:f.value?"编辑场次":"新增场次","on-before-ok":A,onCancel:H},{default:l(()=>[t(B,{ref_key:"sessionFormRef",ref:C,model:o,rules:z,"auto-label-width":""},{default:l(()=>[t(I,{field:"title",label:"场次标题"},{default:l(()=>[t(y,{modelValue:o.title,"onUpdate:modelValue":e[0]||(e[0]=a=>o.title=a),placeholder:"请输入场次标题（可选）","allow-clear":""},null,8,["modelValue"])]),_:1}),t(I,{field:"saleTimeRange",label:"售卖时间",rules:[{required:!0,message:"请选择售卖时间范围"}]},{default:l(()=>[t(P,{modelValue:o.saleTimeRange,"onUpdate:modelValue":e[1]||(e[1]=a=>o.saleTimeRange=a),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(I,{field:"showTimeRange",label:"演出时间",rules:[{required:!0,message:"请选择演出时间范围"}]},{default:l(()=>[t(P,{modelValue:o.showTimeRange,"onUpdate:modelValue":e[2]||(e[2]=a=>o.showTimeRange=a),"show-time":"",placeholder:["开始时间","结束时间"],"value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),Te=te(fe,[["__scopeId","data-v-4c9a3b9f"]]);export{Te as default};
